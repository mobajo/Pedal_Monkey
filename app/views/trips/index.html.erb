<h1>index</h1>  


<div style='width: 800px;'>
  <div id="directions" style='width: 800px; height: 400px;'></div>
</div>

<% start_address = @trip.stages.first.start_point.address %>
<% destination_address = @trip.stages.last.end_point.address %>

<%= content_for(:after_js) do %>
<script>

  var directionsDisplay = new google.maps.DirectionsRenderer();
  var directionsService = new google.maps.DirectionsService();

  function calcRoute() {
    /* var origin      = new google.maps.LatLng(55.676097, 12.568337); */
    /* var destination = new google.maps.LatLng(55.663895, 12.542540); */

    /* This code iterates over each stage of a user trip and sets the waypoint(s) as the end_point address as defined by the user */ 

   /* var waypts = [];
     <% @trip.stages.each do |stage|  %>
      <% break if stage.end_point.final_stop? %> 
      var stop = '<%= raw stage.end_point.address %>'
      waypts.push({
          location: stop,
          stopover: true,
      });
    <% end %>
    console.log(waypts) */

    /* This code specifies the input of the request sent to the google maps directions API. Origin (start of trip) and destination (end of trip) is defined by the trip user (lines 13:14). Waypoints are given as an array of object(?) */ 

    var request = {
      origin:             '<%= start_address %>',  
      destination:        '<%= destination_address %>',
      waypoints:          [{
        location: '52.7997936, -2.11537670000007',
        stopover: true,
      }, {
        location: '52.1027959, -2.1917410999999447',
        stopover: true,
      }],
      optimizeWaypoints:  true,
      travelMode:         google.maps.TravelMode.BICYCLING

    };

    /* Not totally sure about this code, but my guess is it fetches information for directions. It gives back a 'response', which contains all the needed */

    directionsService.route(request, function(response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        
        /* in this code the number of waypoints and intervals between each waypoint(wayPointsDistance) we want to autocreate, when the user specifies a start and end in the search, is defined. numberOfWaypoints is currently fixed, but should be made dynamic with what the user specifies in the search */ 
        
        numberOfWaypoints = 3
        totalTripDistance = response.routes[0].legs[0].distance.value

        wayPointInterval = totalTripDistance / numberOfWaypoints 

        console.log(wayPointInterval);

        wayPointsDistance = [wayPointInterval]

        /* Here the distance on the trip at which each waypoint should be is set. the waypoints are pushed into an array */    

        let i = wayPointsDistance;
        while (i.length <= (numberOfWaypoints - 2)) {

          i.push(wayPointInterval += wayPointInterval);
        }
        console.log(i)

        /* Expected Duration of each stage in the trip is specified */


        const leg_array = response.routes[0].legs

        leg_array.forEach((leg) => {
         console.log(leg.duration.text );  
       });

        /* BOSS-CODE ALERT!! - this code gets the coordinates of the autocreated waypoints, when user searches. The code iterates over each step of the trip and fetches the length(distance) of the step. When the totalmeters count reaches a waypoint in the wayPointDistance array, it pushes the lat,lng coordinates of the start_location of the last step into an array. */        

        let step_array = [];
        let kmtest = response.routes[0].legs[0].steps; 
        let totalmeters = 0;
        let j = 0;
        
        wayPoint = wayPointsDistance[j];

        kmtest.forEach((step) => {
          totalmeters += step.distance.value;
          if (totalmeters > wayPoint) {
            step_array.push(step.start_location.lat());
            step_array.push(step.start_location.lng());
            console.log(wayPoint)
            j++;
            wayPoint = wayPointsDistance[j];
            console.log(wayPoint);
          };
        });
        console.log(step_array);
      }
    });
  }

  /* my guess is this code builds the actual map with the trip,stage,step directions */

  calcRoute();

  var handler = Gmaps.build('Google');
  handler.buildMap({ internal: {id: 'directions'}}, function(){
    directionsDisplay.setMap(handler.getMap());
  });
</script>

<% end %>